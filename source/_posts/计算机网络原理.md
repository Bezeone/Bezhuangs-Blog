---
title: 计算机网络原理
date: 2020-12-04
updated: 2021-02-04
group: going
tags: [TCP/IP]
categories: 计算机专业
references:
  - title: 哈尔滨工业大学计算机网络
    url: http://www.icourse163.org/learn/HIT-154005
  - title: 计算机网络（第7版）
    url: https://book.douban.com/subject/26960678/
  - title: 2021版天勤计算机考研高分笔记系列
    url: https://book.douban.com/series/54664
  - title: 全国计算机学科专业综合考试大纲
    url: http://www.neea.edu.cn/html1/report/16103/1332-1.htm
---

> 计算机网络原理是通信技术与计算机技术紧密结合的产物，我们所学的编程知识，离开了网络去谈也毫无意义，因此它也是计算机专业知识体系中不可或缺的一门课程，同时也是408考研科目之一。这篇笔记主要记录的是计算机网络学习的核心内容，包括IPv4，TCP，UDP等以及地址字段的意义和地址结构。

<!--more-->

### 计算机网络体系结构

#### 计算机网络概述

- 计算机网络是通信技术与计算机技术紧密结合的产物，是一种通信网络。
- 计算机网络就是互连的、自治的计算机集合。
- 通过交换网络互连主机
- ISP(Internet Service Provider)网络互连的“网络之网络”
- 计算设备集合：主机(hosts)=端系统（end systems）
- 通信链路：光纤, 铜缆, 无线电, 卫星……
- 分组交换: 转发分组 (数据包)：路由器(routers) 和交换机(switches)
- 网络协议(network protocol)，简称为协议，是为进行网络中的数据交换而建立的规则、标准或约定
- 协议规定了通信实体之间所交换的消息的格式、意义、顺序以及针对收到信息或发生的事件所采取的“动作”（actions）
- 协议的三要素：语法、语义、时序
- Internet协议标准
  - RFC: Request for Comments
  - IETF:互联网工程任务组（Internet Engineering Task Force）

#### 计算机网络结构
- 网络边缘
  - 主机(端系统)
  - 客户/服务器(client/server)应用模型
  - 对等(peer-peer, P2P)应用模型
- 接入网络（物理介质）
  - 数字用户线路 (DSL)
  - 电缆网络（频分多路复用）
  - 电缆网络（HFC:混合光纤同轴电缆）
  - 机构（企业）接入网络 (Ethernet)
  - 无线接入网络（LAN/蜂窝网）
- 网络核心
  - 网络核心的关键功能:路由+转发
  - 路由(routing)：确定分组从源到目的传输路径
  - 转发(forwarding)：将分组从路由器的输入端口交换至正确的输出端口
  - 通过数据交换实现数据从源主机通过网络核心送达目的主机
- Internet结构：端系统通过接入ISP（access ISPs ）连接到Internet
- 在网络中心: 少数互连的大型网络
  - “一级”(tier-1)商业ISPs（如：网通、电信、Sprint、 AT&T），提供国家或国际范围的覆盖
  - 内容提供商网络（content provider network， 如：Google）：私有网络，连接其数据中心与Internet，通常绕过一级ISP和区域ISPs

#### 网络核心
- 数据交换-电路交换
  - 最典型电路交换网络：电话网络
  - 电路交换的三个阶段：建立连接（呼叫/电路建立）-> 通信 -> 释放连接（拆除电路）
  - 独占资源
- 多路复用(multiplexing)，简称复用，是通信技术中的基本概念
  - 链路/网络资源（如带宽）划分为“资源片”，将资源片分配给各路“呼叫”（calls），每路呼叫独占分配到的资源片进行通信
  - 资源片可能“闲置”(idle) (无共享) 
- 典型多路复用方法:
  - 频分多路复用(frequency division multiplexing-FDM)：各用户占用不同的频率带宽资源
  - 时分多路复用(time division multiplexing-TDM)：将时间划分为一段段等长的时分复用帧
  - 波分多路复用(Wavelength division multiplexing-WDM)：光的频分复用
  - 码分多路复用(Code division multiplexing-CDM)：每个用户分配一个唯一的m bit 码片序列(chipping sequence)，各用户使用相同频率载波
- 编码信号 = (原始数据) × (码片序列)，各用户码片序列相互正交(orthogonal)
- 解码: 码片序列与编码信号的内积
- 报文交换（message switching）：源（应用）发送信息整体
- 分组交换（package switching）：报文分拆出来的一系列相对较小的数据包
  - 报文的拆分与重组
  - 统计多路复用（Statistical Multiplexing）
- 报文交换与分组交换均采用存储-转发交换方式
- 分组传输延迟（delay）= L (bits) / R (bits/sec)
- 分组交换的报文交付时间 T = M/R+(h-1)L/R = M/R+nL/R
- 分组交换优缺点：适用于突发数据传输网络，资源充分共享，简单、无需呼叫建立，但是可能产生拥塞，造成分组延迟和丢失，需要协议处理可靠数据传输和拥塞控制

#### 计算机网络性能
- 速率：即数据率(data rate)或称数据传输速率或比特率(bit rate)，单位时间（秒）传输信息（比特）量，是计算机网络中最重要的一个性能指标
- 速率单位：b/s（或bps）、kb/s、Mb/s、Gb/s
- 速率往往是指额定速率或标称速率
- “带宽”(bandwidth)原本指信号具有的频带宽度，即最高频率与最低频率之差，单位是赫兹（Hz）
- 网络的“带宽”通常是数字信道所能传送的“最高数据率”，单位：b/s (bps)
- 延迟/时延(delay或latency)
- 四种分组延迟
  - dproc: 结点处理延迟（nodal processing delay），差错检测，确定输出链路，通常< msec
  - dqueue: 排队延迟（queueing delay），等待输出链路可用，取决于路由器拥塞程度
  - dtrans: 传输延迟（transmission delay）= 分组长度(bits) / 链路带宽 (bps)
  - dprop: 传播延迟（propagation delay）= 物理链路长度 / 信号传播速度(~2×108 m/sec)
- 排队延迟：流量强度（traffic intensity）= 分组长度 (bits) * 平均分组到达速率 / 链路带宽(bps)
- 时延带宽积 = 传播时延 * 带宽
- 链路的时延带宽积又称为以比特为单位的链路长度
- 分组丢失（丢包）：队列缓存容量有限，分组到达已满队列将被丢弃 (即丢包)
- 丢包率 = 丢包数 / 已发分组总数
- 吞吐量/率（Throughput）：表示在发送端与接收端之间传送数据速率 (b/s)
  - 即时吞吐量：给定时刻的速率
  - 平均吞吐量：一段时间的平均速率
- 瓶颈链路（bottleneck link）：端到端路径上，限制端到端吞吐量的链路。

#### 计算机网络体系结构
- 网络体系结构是从功能上描述计算机网络结构
- 计算机网络体系结构简称网络体系结构(network architecture)是分层结构
- 每层遵循某个/些网络协议完成本层功能
- 计算机网络体系结构是计算机网络的各层及其协议的集合
- 体系结构是一个计算机网络的功能层次及其关系的定义，体系结构是抽象的
- 分层结构的优点：结构清晰，有利于识别复杂系统的部件及其关系；模块化的分层易于系统更新、维护；有利于标准化
- 实体(entity) 表示任何可发送或接收信息的硬件或软件进程。
- 协议是控制两个对等实体进行通信的规则的集合，协议是“水平的” 。
- 任一层实体需要使用下层服务，遵循本层协议，实现本层功能，向上层提供服务，服务是“垂直的”。
- 下层协议的实现对上层的服务用户是透明的。
- 同系统的相邻层实体间通过接口进行交互，通过服务访问点 SAP (Service Access Point)，交换原语，指定请求的特定服务。
- Cerf与Kahn网络互连基本原则 ——当今Internet体系结构
  - 极简（minimalism）、 自治（autonomy）- 无需改变内部网络实现网络互连
  - 尽力服务（best effort service）模型
  - 无状态路由器
  - 分散控制

#### OSI与Internet参考模型
- 开放系统互连 (OSI)参考模型是由国际标准化组织 (ISO) 于1984年提出的分层网络体系结构模型，目的是支持异构网络系统的互联互通，是异构网络系统互连的国际标准
  ```
  应用层（Application）
  表示层（Presentation）
  会话层（Session）
  传输层（Transport）
   
  网络层（Network）
  数据链路层（Data link）
  物理层（Physical）
  ```
- 数据封装：增加控制信息，构造协议数据单元 (PDU)
- 控制信息主要包括:
  - 地址（Address）: 标识发送端/接收端
  - 差错检测编码（Error-detecting code）: 用于差错检测或纠正
  - 协议控制（Protocol control）: 实现协议功能的附加信息，如: 优先级（priority）、服务质量（QoS）、 和安全控制等
- 物理层功能：
  - 接口特性：机械特性、电气特性、功能特性、规程特性
  - 比特编码
  - 数据率
  - 比特同步：时钟同步
  - 传输模式：单工（Simplex）、半双工（half-duplex）、全双工（full-duplex）
- 数据链路层功能：负责结点-结点（node-to-node）数据传输
  - 组帧（Framing）
  - 物理寻址（Physical addressing）：在帧头中增加发送端和/或接收端的物理地址标识数据帧的发送端和/或接收端
  - 流量控制（Flow control）：避免淹没接收端
  - 差错控制（Error control）：检测并重传损坏或丢失帧，并避免重复帧
  - 访问(接入)控制（Access control）：在任一给定时刻决定哪个设备拥有链路（物理介质）控制使用权
- 网络层功能：负责源主机到目的主机数据分组（packet）交付：可能穿越多个网络
  - 逻辑寻址（Logical addressing）：全局唯一逻辑地址，确保数据分组被送达目的主机，如IP地址
  - 路由（Routing）：路由器(或网关)互连网络，并路由分组至最终目的主机；路径选择
  - 分组转发
- 传输层功能：负责源-目的（端-端） （进程间） 完整报文传输
  - 分段与重组
  - SAP寻址：确保将完整报文提交给正确进程，如端口号
  - 连接控制
  - 流量控制
  - 差错控制
- 会话层功能：最“薄”的一层
  - 对话控制（dialog controlling）：建立、维护
  - 同步(synchronization)：在数据流中插入“同步点”
- 表示层功能：处理两个系统间交换信息的语法与语义（syntax and semantics）问题
  - 数据表示转化
  - 转换为主机独立的编码
  - 加密/解密
  - 压缩/解压缩
- 应用层功能：支持用户通过用户代理（如浏览器）或网络接口使用网络（服务）
  
  - 典型应用层服务：文件传输（FTP）、电子邮件（SMTP）、Web（HTTP）
- TCP/IP参考模型：IP over Everything
  ```
  应用层     HTTP  SMTP  DNS  RTP
  运输层          TCP        UDP
  网际层               IP
  网络接口层   网络接口1   网络接口2 
  ```
- 5层参考模型：综合 OSI 和 TCP/IP 的优点
  ```
  应用层: 支持各种网络应用；FTP, SMTP, HTTP
  传输层: 进程-进程的数据传输；TCP, UDP
  网络层: 源主机到目的主机的数据分组路由与转发；IP协议、路由协议等
  链路层: 相邻网络元素（主机、交换机、路由器等）的数据传输；以太网（Ethernet）、802.11 (WiFi)、PPP
  物理层: 比特传输
  ```

#### 计算机网络与Internet发展历史
- 1961-1972: 早期分组交换原理的提出与应用
  - 1961: Kleinrock – 排队论证实分组交换的有效性
  - 1964: Baran – 分组交换应用于军事网络
  - 1967: ARPA（Advanced Research Projects Agency）提出ARPAnet构想
  - 1969: 第一个ARPAnet 结点运行
  - 1972:ARPAnet公开演示；第一个主机-主机协议NCP (Network Control Protocol)；第一个e-mail程序；ARPAnet拥有15个结点
- 1972-1980: 网络互连，大量新型、私有网络的涌现
  - 1970:在夏威夷构建了 ALOHAnet卫星网络
  - 1974: Cerf 与 Kahn – 提出网络互连体系结构
  - 1976: Xerox设计了以太网
  - 70’s后期：私有网络体系结构: DECnet, SNA, XNA；固定长度分组交换 (ATM 先驱)
  - 1975：ARPAnet移交给美国国防部通信局管理
  - 1979: ARPAnet拥有200结点
- 1980-1990: 新型网络协议与网络的激增
  - 1983: 部署TCP/IP
  - 1982: 定义了smtp电子邮件协议
  - 1983: 定义了DNS
  - 1985: 定义了FTP协议
  - 1988: TCP拥塞控制；新型国家级网络: CSnet, BITnet, NSFnet, Minitel（法国）
  - 1986：NSFnet初步形成了一个由骨干网、区域网和校园网组成的三级网络；100,000台主机连接公共网络
- 1990, 2000’s: 商业化, Web, 新应用
  - 1990’s早期: ARPAnet退役
  - 1991: NSF解除NSFnet的商业应用限制(1995年退役)，由私营企业经营
  - 1992:因特网协会ISOC成立
  - 1990s后期: Web应用；超文本（hypertext） [Bush 1945, Nelson 1960’s]；HTML, HTTP: Berners-Lee
  - 1994: Mosaic、Netscape浏览器
  - 1990’s后期:Web开始商业应用
  - 1990’s后期 – 2000’s：更多极受欢迎的网络应用: 即时消息系统（如QQ）， P2P文件共享；网络安全引起重视；网络主机约达50000，网络用户达1亿以上；网络主干链路带宽达到Gbps
- 2005-今
  - ~7.5亿主机：智能手机和平板电脑
  - 宽带接入的快速部署
  - 无处不在的高速无线接入快速增长
  - 出现在线社交网络：Facebook: 很快拥有10亿用户；服务提供商 (如Google, Microsoft)创建其自己的专用网络；绕开Internet，提供“即时”接入搜索、email等服务；电子商务、大学、企业等开始在“云”中运行自己的服务 (如， Amazon EC2)

#### 网络应用的基本原理

#### 网络应用的体系结构

- 客户机/服务器结构 (Client-Server, C/S)，如Web
  - 服务器（7*24小时提供服务，永久性访问地址/域名，利用大量服务器实现可扩展性）
  - 客户机（与服务器通信，使用服务器提供的服务，间歇性接入网络，可能使用动态IP地址，不会与其他客户机直接通信）
- 点对点结构(Peer-to-peer, P2P)
  - 没有永远在线的服务器，任意端系统/节点之间可以直接通讯，节点间歇性接入网络，节点可能改变IP地址
  - 优点：高度可伸缩，缺点：难于管理
- 混合结构(Hybrid)，如Napster
  - 文件传输使用P2P结构，文件的搜索采用C/S结构—集中式

#### 网络应用进程通信

- 网络应用的基础：进程间通信
  - 进程：主机上运行的程序
  - 同一主机上运行的进程间通信：操作系统提供进程间通信机制
  - 不同主机上运行的进程间通信：消息交换
- 套接字：Socket
  - 进程间通信利用socket发送/接收消息实现
  - 类似于寄信
  - 传输基础设施向进程提供API：传输协议的选择，参数的设置

- 寻址进程
  - 不同主机上的进程间通信，每个进程必须拥有标识符
  - 寻址主机：IP地址
  - 同一主机上可能同时有多个进程需要通信
  - 端口号/Port number：为主机上每个需要通信的进程分配一个端口号（HTTP Server: 80、Mail Server: 25）
  - 进程的标识符：IP地址+端口号
- 应用层协议
  - 网络应用需遵循应用层协议
  - 公开协议：由RFC (Request For Comments)定义，允许互操作
    ，HTTP, SMTP, ……
  - 私有协议：多数P2P文件共享应用

- 应用层协议的内容
  - 消息的类型(type)：请求消息 / 响应消息
  - 消息的语法(syntax)和格式：字段(field)
  - 字段的语义(semantics)：字段中信息的含义
  - 规则(rules)：进程何时如何发送/响应消息

#### 网络应用的需求

- 数据丢失(data loss) / 可靠性(reliability)
- 时间(timing) / 延迟(delay)
- 带宽(bandwidth)

#### Internet提供的传输服务

- TCP服务
  - 面向连接: 客户机/服务器进程间,需要建立连接
  - 可靠的传输
  - 流量控制: 发送方不会发送速度过快，超过接收方的处理能力
  - 拥塞控制: 当网络负载过重时能够限制发送方的发送速度
  - 不提供时间/延迟保障
  - 不提供最小带宽保障
- UDP服务
  - 无连接
  - 不可靠的数据传输
  - 不提供：可靠性保障、流量控制、拥塞控制、延迟保障、带宽保障

#### Web应用

#### Web与HTTP协议概述

- World Wide Web: Tim Berners-Lee
- 网页(Web Page)包含多个对象(objects)
  - 对象：HTML文件、JPEG图片、视频文件、动态脚本等
  - 基本HTML文件：包含对其他对象引用的链接
- 对象的寻址(addressing)
  - URL(Uniform Resoure Locator)：统一资源定位器
  - Scheme://host:port/path

- 超文本传输协议：HyperText Transfer Protocol
- 使用TCP传输服务
- HTTP协议是无状态(stateless)协议：服务器不维护任何有关客户端过去所发请求的信息

#### HTTP连接

- 非持久性连接(Nonpersistent HTTP)
  - 每个TCP连接最多允许传输一个对象
  - HTTP 1.0版本使用非持久性连接
  - 每个对象需要2个RTT
  - 操作系统需要为每个TCP连接开销资源(overhead)
- 持久性连接(Persistent HTTP)
  - 发送响应后，服务器保持TCP连接的打开，后续的HTTP消息可以通过这个连接发送
  - 每个TCP连接允许传输多个对象
  - HTTP 1.1版本默认使用带有流水机制的持久性连接
  - 客户端只要遇到一个引用对象就尽快发出请求，理想情况下，收到所有的引用对象只需耗时约1个RTT
- RTT(Round Trip Time)：从客户端发送一个很小的数据包到服务器并返回所经历的时间
- 响应时间(Response time)：发起、建立TCP连接（1个RTT）+ 发送HTTP请求消息到HTTP响应消息的前几个字节到达（1个RTT）+ 响应消息中所含的文件/对象传输时间
- Total=2RTT +文件发送时间

#### HTTP消息格式

- 请求消息(request)
  - ASCII：人直接可读
  - GET，POST，HEAD，PUT（将消息体中的文件上传到URL字段所指定的路径），DELETE（删除URL字段所指定的文件）
  - 上传输入的方法
    - POST方法：网页经常需要填写表格(form)，在请求消息的消息体(entity body)中上传客户端的输入
    - URL方法：使用GET方法，输入信息通过request行的URL字段上传

- 响应消息(response)
  - HTTP响应状态代码：响应消息的第一行（404 Not Found）

#### Cookie技术

- 某些网站为了辨别用户身份、进行session跟踪而储存在用户本地终端上的数据（通常经过加密）
- RFC6265标准
- Cookie的组件
  - HTTP响应消息的cookie头部行
  - HTTP请求消息的cookie头部行
  - 保存在客户端主机上的cookie文件，由浏览器管理
  - Web服务器端的后台数据库

#### Web缓存/代理服务器技术

- 功能：在不访问服务器的前提下满足客户端的HTTP请求
- 优点：缩短客户请求的响应时间，减少机构/组织的流量，在大范围内(Internet)实现有效的内容分发（CDN）
- 用户设定浏览器通过缓存进行Web访问，浏览器向缓存/代理服务器发送所有的HTTP请求
- 缓存既充当客户端，也充当服务器，一般由ISP(Internet服务提供商)架设

- 条件性GET方法：如果缓存有最新的版本，则不需要发送请
  求对象
  - 缓存：在HTTP请求消息中声明所持有版本的日期 `If-modified-since: <date>`
  - 服务器：如果缓存的版本是最新的，则响应消息中不包含对象 `HTTP/1.0 304 Not Modified`

#### Email应用

#### Email概述

- 邮件客户端
- 邮件服务器(Mail Server)
  - 邮箱：存储发给该用户的Email
  - 消息队列(message queue)：存储等待发送的Email
- SMTP协议 (Simple Mail Transfer Protocol)
  - 邮件服务器之间传递消息所使用的协议
  - 客户端：发送消息的服务器
  - 服务器：接收消息的服务器
  - RFC 2821
  - 使用TCP进行email消息的可靠传输
  - 端口25
  - 传输过程的三个阶段：握手，消息的传输，关闭
  - 命令/响应交互模式：命令(command): ASCII文本，响应(response): 状态代码和语句
  - 使用持久性连接
  - 要求消息必须由7位ASCII码构成
  - SMTP服务器利用CRLF.CRLF确定消息的结束。

- SMTP与HTTP对比
  - HTTP：拉式(pull)，SMTP：推式(push)
  - 都使用命令/响应交互模式
  - 命令和状态代码都是ASCII码
  - HTTP每个对象封装在独立的响应消息中，SMTP多个对象在由多个部分构成的消息中发送

#### Email消息格式与POP3协议

- SMTP：email消息的传输/交换协议

- RFC 822：文本消息格式标准

  ```
  头部行(header)
    To
    From
    Subject
  消息体(body)
    消息本身
    只能是ASCII字符
  ```

- MIME：多媒体邮件扩展RFC 2045, 2056，通过在邮件头部增加额外的行以声明MIME的内容类型

- 邮件访问协议：从服务器获取邮件
  - POP: Post Office Protocol [RFC 1939]：认证/授权(客户端服务器)和下载（POP3是无状态的）
  - IMAP: Internet Mail Access Protocol [RFC 1730]：更多功能，更加复杂，能够操纵服务器上存储的消息，允许用户利用文件夹组织消息，支持跨会话(Session)的用户状态

#### DNS应用

#### DNS概述：Domain Name System

- 域名解析系统DNS：多层命名服务器构成的分布层次式数据库
- 应用层协议：完成名字的解析

- DNS服务：域名向IP地址的翻译，主机别名，邮件服务器别名，负载均衡：Web服务器
- DNS根域名服务器：本地域名解析服务器无法解析域名时，访问根域名服务器
- 根域名服务器如果不知道映射，访问权威域名服务，获得映射，向本地域名服务器返回映射
- 顶级域名服务器(TLD, top-level domain): 负责com, org, net,edu等顶级域名和国家顶级域名，例如cn, uk, fr等
  - Network Solutions维护com顶级域名服务器
  - Educause维护edu顶级域名服务器
- 权威(Authoritative)域名服务器：组织的域名解析服务器，提供组织内部服务器的解析服务
  - 组织负责维护 or 服务提供商负责维护
- 本地域名解析服务器（不严格属于层级体系）
  - 每个ISP有一个本地域名服务器（默认域名解析服务器）
  - 当主机进行DNS查询时，查询被发送到本地域名服务器
    ，作为代理(proxy)，将查询转发给（层级式）域名解析服务器系统

- DNS查询：迭代查询 or 递归查询
- DNS记录缓存和更新：只要域名解析服务器获得域名—IP映射，即缓存这一映射，一段时间过后，缓存条目失效（删除）
- 本地域名服务器一般会缓存顶级域名服务器的映射，因此根域名服务器不经常被访问
- 记录的更新/通知机制：RFC 2136
  - Dynamic Updates in the Domain Name System (DNS UPDATE)

#### DNS记录和消息格式

- 资源记录(RR, resource records)
- RR format: (name, value, type, ttl)
  - Type=A，Name: 主机域名，Value: IP地址
  - Type=NS，Name: 域(edu.cn)，Value: 该域权威域名解析服务器的主机域名
  - Type=CNAME，Name: 某一真实域名的别名，Value: 真实域名
  - Type=MX，Value是与name相对应的邮件服务器

- DNS协议：查询(query)和回复(reply消息)，消息格式相同
- 消息头部
  - Identification: 16位查询编号，回复使用相同的编号
  - flags：查询或回复、期望递归、递归可用、权威回答

- 注册域名：在域名管理机构注册域名，向域名管理机构提供你的权威域名解析服务器的名字和IP地址，域名管理机构向com顶级域名解析服务器中插入两条记录